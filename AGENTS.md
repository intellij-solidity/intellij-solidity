# IntelliJ Solidity Agent Contributor Guide

The project aims to create the best Solidity language plugin for JetBrains IDEs.

## Lexer & Parser

The flex lexer is in `src/main/grammars/_SolidityLexer.flex`
The parser grammar is in `src/main/grammars/solidity.bnf`
The g4 grammars are `src/main/grammars/reference` are the reference grammars that are checked in for convenience. They 
never need to be updated. 

Every time you change the BNF grammar or the flex lexer, you'll need to run the following for the changes to take
effect:

```bash
./gradlew generateLexer generateParser
```

For the parser tests, the tests correspond to sol (input) and txt (output) files in src/test/resources/fixtures/parser.
Each test will read the input sol file, parse it, and compare the resulting PSI tree against the expected output in the
corresponding txt file.
The test will fail if the actual PSI tree does not match the expected output, or if there is PsiErrorElement in the
tree.
If there is a mismatch, the test will fail. If the test fails, it doesn't mean the parser is broken, it just means the
expected output has changed.
You can regenerate the expected output by removing the txt file, then running the test again to regenerate it, and then
re-running the test to ensure the output doesn't contain any errors.

**Tip:** Instead of manually updating the .txt files for the tests, you can delete the .txt file and re-run the
test. The test framework will automatically regenerate the .txt file with the correct output.

### Advanced Lexer and Parser Guidelines

These guidelines are crucial for maintaining a robust and adaptable lexer/parser.

#### 1. Prioritize Lexer Rule Order and Specificity

* **Context:** JFlex (the lexer generator) matches the longest possible sequence of input. If multiple rules match the
  same longest sequence, the rule defined *first* in the `.flex` file takes precedence.
* **Guidance:** For overlapping patterns, especially delimiters with optional parts (like whitespace control hyphens),
  place the most specific (longest) rule *before* more general ones within the same lexer state.

#### 2. Ensure BNF Syntax for Optionality is Correct (Grammar-Kit)

* **Context:** Grammar-Kit's BNF dialect uses `[element_name_or_literal]` for optional elements.
* **Guidance:**
    * Use `[my_rule_or_token]` to make it optional.
    * Do not use regex-style `element?` or `[element]?` with a question mark after the brackets.
    * For an optional sequence: `[ (rule_A rule_B) ]`.
    * Repetition: `rule*` (zero or more), `rule+` (one or more).

#### 3. Debugging with PSI Output and Iterative Changes

* **Context:** Parser errors can be tricky. The generated `.txt` files (PSI trees) are key.
* **Guidance:**
    * Look for `PsiErrorElement`. The error message often lists expected tokens versus the actual token that caused the
      failure.
    * Make small, incremental changes to `.flex` or `.bnf` files. After each change, regenerate and run relevant tests
      to isolate errors quickly.

## Common Mistakes and How to Avoid Them

* Never edit files manually with the "This is a generated file" header, they're generated by the BNF grammar or the flex
  lexer.

## Project Structure

- `src/` – Plugin sources and tests
    - `src/main/grammars/` – JFlex lexer (`_SolidityLexer.flex`), Grammar-Kit parser (`solidity.bnf`), and reference grammars
        - `reference/` – ANTLR4 reference grammars (`Solidity.g4`, `SolidityLexer.g4`)
    - `src/main/kotlin/` – Kotlin production sources under `me.serce.solidity`
        - `ide/` – IDE-specific functionality
            - `actions/` – IDE actions
            - `annotation/` – code annotation functionality
            - `colors/` – color scheme definitions
            - `formatting/` – code formatting functionality
            - `hints/` – code hints and documentation providers
            - `inspections/` – code inspection functionality
            - `liveTemplates/` – live template definitions
            - `navigation/` – code navigation functionality
            - `refactoring/` – refactoring functionality
        - `lang/` – Solidity language support
            - `completion/` – code completion functionality
            - `core/` – core language functionality (lexer, parser, tokens, file type)
            - `psi/` – PSI (Program Structure Interface) definitions
            - `resolve/` – reference resolution functionality
            - `stubs/` – stub index functionality
            - `types/` – type system functionality
    - `src/main/resources/` – Plugin resources
        - `META-INF/plugin.xml` – plugin descriptor
        - `fileTemplates/` – file templates
        - `icons/` – plugin icons
        - `inspectionDescriptions/` – descriptions for code inspections
        - `liveTemplates/` – live template definitions
    - `src/test/` – Kotlin tests
        - `kotlin/me/serce/solidity/` – Test sources mirroring production code structure
            - `ide/` – tests for IDE-specific functionality
            - `lang/` – tests for language-specific functionality
            - `utils/` – test utilities
        - `resources/fixtures/` – test fixtures
            - `parser/` – parser test fixtures
            - `formatter/` – formatter test fixtures
            - `folding/` – folding test fixtures
            - `import/` – import test fixtures
            - `refactoring/` – refactoring test fixtures

## Agent workflow

If you are corrected or notice a significant and important piece of information 

### Codex-specific instructions

When running gradle tasks, use the `--no-daemon` flag to avoid issues with the Gradle daemon inside the container.
